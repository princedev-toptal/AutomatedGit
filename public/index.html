<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Git - Automated Branch, Commit & Push</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .results {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .result-item {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .result-item.error {
            border-left-color: #dc3545;
        }

        .result-item.success {
            border-left-color: #28a745;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .check-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .check-modal.active {
            display: flex;
        }

        .check-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .check-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .check-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .check-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .check-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .check-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-label {
            font-weight: 600;
            color: #555;
            flex: 1;
        }

        .check-value {
            color: #333;
            flex: 1;
            text-align: right;
        }

        .check-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .check-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .check-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .check-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .check-buttons button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .dates-preview {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Auto Git</h1>
        <p class="subtitle">Automated Branch Creation, Commits & Push</p>

        <form id="gitForm">
            <div class="form-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate" name="startDate" required>
                <div class="help-text">First date to process</div>
            </div>

            <div class="form-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate" name="endDate" required>
                <div class="help-text">Last date to process</div>
            </div>

            <div class="form-group">
                <label for="country">Country</label>
                <select id="country" name="country" required>
                    <option value="">Loading countries...</option>
                </select>
                <div class="help-text">Select country to exclude its holidays (Sundays are always excluded)</div>
            </div>

            <div class="form-group">
                <label for="percentage">Commit Percentage</label>
                <input type="number" id="percentage" name="percentage" min="0" max="100" step="0.1" value="100" required>
                <div class="help-text">Percentage of available dates to commit (0-100). Example: 50 means commit for 50% of available dates</div>
            </div>

            <div class="form-group">
                <label for="repoPath">Repository Path</label>
                <input type="text" id="repoPath" name="repoPath" placeholder="./repo" value="./repo" required>
                <div class="help-text">Path to your git repository (will be created if it doesn't exist)</div>
            </div>

            <div class="form-group">
                <label for="remote">Remote Name (Optional)</label>
                <input type="text" id="remote" name="remote" placeholder="origin" value="origin">
                <div class="help-text">Git remote name (default: origin)</div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="createPR" name="createPR" style="width: auto; margin-right: 8px;">
                    Create Pull Requests
                </label>
                <div class="help-text">Automatically create PRs after pushing branches</div>
            </div>

            <div id="prOptions" style="display: none;">
                <div class="form-group">
                    <label for="platform">Platform</label>
                    <select id="platform" name="platform">
                        <option value="github">GitHub</option>
                        <option value="gitlab">GitLab (Coming Soon)</option>
                        <option value="bitbucket">Bitbucket (Coming Soon)</option>
                    </select>
                    <div class="help-text">Git hosting platform</div>
                </div>

                <div class="form-group">
                    <label for="prToken">API Token</label>
                    <input type="password" id="prToken" name="prToken" placeholder="ghp_xxxxxxxxxxxx">
                    <div class="help-text">Personal Access Token for API access (GitHub: Settings ‚Üí Developer settings ‚Üí Personal access tokens)</div>
                </div>

                <div class="form-group">
                    <label for="baseBranch">Base Branch</label>
                    <input type="text" id="baseBranch" name="baseBranch" placeholder="main" value="main">
                    <div class="help-text">Branch to merge PRs into (default: main)</div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoMerge" name="autoMerge" style="width: auto; margin-right: 8px;">
                        Auto-merge PRs
                    </label>
                    <div class="help-text">Automatically merge PRs after creation</div>
                </div>

                <div class="form-group" id="mergeMethodGroup" style="display: none;">
                    <label for="mergeMethod">Merge Method</label>
                    <select id="mergeMethod" name="mergeMethod">
                        <option value="merge">Merge Commit</option>
                        <option value="squash">Squash and Merge</option>
                        <option value="rebase">Rebase and Merge</option>
                    </select>
                    <div class="help-text">How to merge the PR (GitHub only)</div>
                </div>
            </div>

            <button type="submit" id="submitBtn">Start Processing</button>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px;">Processing dates...</p>
        </div>

        <div class="status" id="status"></div>

        <div class="results" id="results"></div>
    </div>

    <!-- Check/Confirmation Modal -->
    <div class="check-modal" id="checkModal">
        <div class="check-content">
            <div class="check-header">
                <h2>üîç Review Settings</h2>
                <p style="color: #666;">Please review all settings before proceeding</p>
            </div>

            <div id="checkContent">
                <!-- Content will be populated by JavaScript -->
            </div>

            <div class="check-buttons">
                <button class="btn-cancel" id="cancelBtn">Go Back</button>
                <button class="btn-confirm" id="confirmBtn">Confirm & Process</button>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('gitForm');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        const countrySelect = document.getElementById('country');
        const checkModal = document.getElementById('checkModal');
        const checkContent = document.getElementById('checkContent');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmBtn = document.getElementById('confirmBtn');
        let currentFormData = null;

        // Cancel button - close modal
        cancelBtn.addEventListener('click', () => {
            checkModal.classList.remove('active');
            submitBtn.disabled = false;
        });

        // Confirm button - proceed with processing
        confirmBtn.addEventListener('click', async () => {
            checkModal.classList.remove('active');
            await processGitOperations(currentFormData);
        });

        // Load countries on page load
        async function loadCountries() {
            try {
                const response = await fetch('/api/countries');
                const data = await response.json();
                
                if (data.success) {
                    countrySelect.innerHTML = '';
                    
                    // Group countries by region
                    const regions = {};
                    data.countries.forEach(country => {
                        const region = country.region || 'Other';
                        if (!regions[region]) {
                            regions[region] = [];
                        }
                        regions[region].push(country);
                    });
                    
                    // Create optgroups for each region
                    const regionOrder = [
                        'North America',
                        'Europe',
                        'Asia-Pacific',
                        'South America',
                        'Africa & Middle East',
                        'Other'
                    ];
                    
                    regionOrder.forEach(region => {
                        if (regions[region] && regions[region].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = region;
                            
                            regions[region].forEach(country => {
                                const option = document.createElement('option');
                                option.value = country.code;
                                option.textContent = country.name;
                                if (country.code === 'US') {
                                    option.selected = true;
                                }
                                optgroup.appendChild(option);
                            });
                            
                            countrySelect.appendChild(optgroup);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading countries:', error);
                countrySelect.innerHTML = '<option value="US">United States</option>';
            }
        }

        // Load countries when page loads
        loadCountries();

        // Show/hide PR options based on checkbox
        const createPRCheckbox = document.getElementById('createPR');
        const prOptionsDiv = document.getElementById('prOptions');
        const autoMergeCheckbox = document.getElementById('autoMerge');
        const mergeMethodGroup = document.getElementById('mergeMethodGroup');

        if (createPRCheckbox) {
            createPRCheckbox.addEventListener('change', () => {
                prOptionsDiv.style.display = createPRCheckbox.checked ? 'block' : 'none';
            });
        }

        if (autoMergeCheckbox) {
            autoMergeCheckbox.addEventListener('change', () => {
                mergeMethodGroup.style.display = autoMergeCheckbox.checked ? 'block' : 'none';
            });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get form data
            const formData = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                country: document.getElementById('country').value,
                percentage: parseFloat(document.getElementById('percentage').value),
                repoPath: document.getElementById('repoPath').value,
                remote: document.getElementById('remote').value || 'origin',
                createPR: document.getElementById('createPR').checked,
                autoMerge: document.getElementById('autoMerge').checked,
                prToken: document.getElementById('prToken').value,
                baseBranch: document.getElementById('baseBranch').value || 'main',
                platform: document.getElementById('platform').value,
                mergeMethod: document.getElementById('mergeMethod').value || 'merge'
            };

            // Validate percentage
            if (formData.percentage < 0 || formData.percentage > 100) {
                showStatus('Percentage must be between 0 and 100', 'error');
                return;
            }

            // Validate dates
            if (new Date(formData.startDate) > new Date(formData.endDate)) {
                showStatus('Start date must be before end date', 'error');
                return;
            }

            // Store form data
            currentFormData = formData;

            // Show loading
            submitBtn.disabled = true;
            loading.style.display = 'block';
            status.style.display = 'none';
            results.style.display = 'none';
            results.innerHTML = '';

            try {
                // Call check API
                const checkResponse = await fetch('/api/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const checkData = await checkResponse.json();
                loading.style.display = 'none';

                if (checkData.success) {
                    // Show check modal with all information
                    displayCheckPage(checkData);
                    checkModal.classList.add('active');
                } else {
                    showStatus(`‚ùå Error: ${checkData.message}`, 'error');
                    submitBtn.disabled = false;
                }
            } catch (error) {
                loading.style.display = 'none';
                showStatus(`‚ùå Network error: ${error.message}`, 'error');
                submitBtn.disabled = false;
            }
        });

        function displayCheckPage(data) {
            const { settings, gitUser, gitRepoInfo } = data;
            
            let html = `
                <div class="check-section">
                    <h3>üìÖ Date Range</h3>
                    <div class="check-item">
                        <span class="check-label">Start Date:</span>
                        <span class="check-value">${settings.startDate}</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">End Date:</span>
                        <span class="check-value">${settings.endDate}</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Total Valid Dates:</span>
                        <span class="check-value">${settings.totalValidDates}</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Dates to Process:</span>
                        <span class="check-value"><strong>${settings.datesToProcess} (${settings.percentage}%)</strong></span>
                    </div>
                    ${settings.validDatesPreview.length > 0 ? `
                        <div class="dates-preview">
                            <strong>Sample dates:</strong> ${settings.validDatesPreview.join(', ')}${settings.totalValidDates > 10 ? '...' : ''}
                        </div>
                    ` : ''}
                </div>

                <div class="check-section">
                    <h3>üåç Country & Settings</h3>
                    <div class="check-item">
                        <span class="check-label">Country:</span>
                        <span class="check-value">${settings.country}</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Commit Percentage:</span>
                        <span class="check-value">${settings.percentage}%</span>
                    </div>
                </div>

                <div class="check-section">
                    <h3>üë§ Git User Configuration</h3>
                    <div class="check-item">
                        <span class="check-label">User Name:</span>
                        <span class="check-value">${gitUser.name}</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">User Email:</span>
                        <span class="check-value">${gitUser.email}</span>
                    </div>
                    ${(gitUser.name === 'Not configured' || gitUser.email === 'Not configured') ? `
                        <div class="check-warning">
                            ‚ö†Ô∏è Git user name or email is not configured. Commits may not have proper author information.
                            <br><small>Configure with: git config --global user.name "Your Name" && git config --global user.email "your.email@example.com"</small>
                        </div>
                    ` : `
                        <div class="check-success">
                            ‚úÖ Git user configuration looks good
                        </div>
                    `}
                </div>

                <div class="check-section">
                    <h3>üìÅ Repository Information</h3>
                    <div class="check-item">
                        <span class="check-label">Repository Path:</span>
                        <span class="check-value">${settings.repoPath}</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Directory Exists:</span>
                        <span class="check-value">${gitRepoInfo.exists ? '‚úÖ Yes' : '‚ö†Ô∏è No (will be created)'}</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Is Git Repository:</span>
                        <span class="check-value">${gitRepoInfo.isRepo ? '‚úÖ Yes' : '‚ö†Ô∏è No (will be initialized)'}</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Remote Name:</span>
                        <span class="check-value">${settings.remote}</span>
                    </div>
                    ${gitRepoInfo.remotes.length > 0 ? `
                        <div class="check-item">
                            <span class="check-label">Configured Remotes:</span>
                            <span class="check-value">${gitRepoInfo.remotes.map(r => r.name).join(', ')}</span>
                        </div>
                        ${gitRepoInfo.remotes.some(r => r.name === settings.remote) ? `
                            <div class="check-success">
                                ‚úÖ Remote "${settings.remote}" is configured
                            </div>
                        ` : `
                            <div class="check-warning">
                                ‚ö†Ô∏è Remote "${settings.remote}" is not configured. You may need to add it before pushing.
                                <br><small>Add with: git remote add ${settings.remote} &lt;repository-url&gt;</small>
                            </div>
                        `}
                    ` : `
                        <div class="check-warning">
                            ‚ö†Ô∏è No remotes configured. You will need to add a remote before pushing.
                            <br><small>Add with: git remote add ${settings.remote} &lt;repository-url&gt;</small>
                        </div>
                    `}
                </div>
            `;

            checkContent.innerHTML = html;
        }

        async function processGitOperations(formData) {
            // Show loading
            submitBtn.disabled = true;
            loading.style.display = 'block';
            status.style.display = 'none';
            results.style.display = 'none';
            results.innerHTML = '';

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                loading.style.display = 'none';

                if (data.success) {
                    showStatus(
                        `‚úÖ ${data.message}\nAvailable dates: ${data.totalDates}, Processed: ${data.datesToProcess} (${data.percentage}%), Success: ${data.successCount}, Failed: ${data.failureCount}`,
                        'success'
                    );
                    showResults(data.results);
                } else {
                    showStatus(`‚ùå Error: ${data.message}`, 'error');
                }
            } catch (error) {
                loading.style.display = 'none';
                showStatus(`‚ùå Network error: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function showResults(resultsArray) {
            results.style.display = 'block';
            results.innerHTML = '<h3 style="margin-bottom: 15px;">Processing Results:</h3>';

            resultsArray.forEach(result => {
                const div = document.createElement('div');
                div.className = `result-item ${result.success ? 'success' : 'error'}`;
                
                let html = `<strong>Date: ${result.results.date}</strong><br>`;
                html += `Branch: ${result.results.branch}<br>`;
                html += `Status: ${result.success ? '‚úÖ Success' : '‚ùå Failed'}<br>`;
                
                if (result.results.branchResult) {
                    html += `Branch: ${result.results.branchResult.success ? '‚úÖ' : '‚ùå'} ${result.results.branchResult.message}<br>`;
                }
                
                if (result.results.commits) {
                    html += `Commits: ${result.results.commits.success ? '‚úÖ' : '‚ùå'} ${result.results.commits.message}<br>`;
                }
                
                if (result.results.push) {
                    html += `Push: ${result.results.push.success ? '‚úÖ' : '‚ùå'} ${result.results.push.message}<br>`;
                }
                
                if (result.results.pr) {
                    html += `PR: ${result.results.pr.success ? '‚úÖ' : '‚ùå'} ${result.results.pr.message}<br>`;
                    if (result.results.pr.prUrl) {
                        html += `<a href="${result.results.pr.prUrl}" target="_blank" style="color: #667eea;">View PR</a><br>`;
                    }
                    if (result.results.pr.merged) {
                        html += `Merged: ‚úÖ ${result.results.pr.mergeMessage || 'Merged successfully'}<br>`;
                    }
                }
                
                if (!result.success) {
                    html += `<em>Error: ${result.message}</em>`;
                }
                
                div.innerHTML = html;
                results.appendChild(div);
            });
        }

        // Set default dates (today and 7 days from now)
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);

        document.getElementById('startDate').value = today.toISOString().split('T')[0];
        document.getElementById('endDate').value = nextWeek.toISOString().split('T')[0];
    </script>
</body>
</html>

